name: Deploy mini-ecom (PM2 + EC2)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_NAME: mini-ecom
      EC2_HOST: "YOUR.EC2.IP.OR.DNS"   # <- replace this
      SERVER_SUBDIR: server
      CLIENT_SUBDIR: client
      RELEASE_DIR: releases

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: |
            client/package-lock.json
            server/package-lock.json

      - name: Build client
        working-directory: ${{ env.CLIENT_SUBDIR }}
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build

      - name: Package server + client build
        id: pkg
        run: |
          set -e
          TS=$(date -u +%Y%m%d%H%M%S)
          echo "ts=$TS" >> $GITHUB_OUTPUT
          mkdir -p deploy_bundle/${{ env.SERVER_SUBDIR }} deploy_bundle/${{ env.CLIENT_SUBDIR }}/build
          rsync -a --exclude=node_modules --exclude=.env --exclude=.git ${{ env.SERVER_SUBDIR }}/ deploy_bundle/${{ env.SERVER_SUBDIR }}/
          rsync -a ${{ env.CLIENT_SUBDIR }}/build/ deploy_bundle/${{ env.CLIENT_SUBDIR }}/build/
          TAR="${{ env.APP_NAME }}-$TS.tgz"
          tar -C deploy_bundle -czf "$TAR" .
          echo "tar=$TAR" >> $GITHUB_OUTPUT
          ls -lh "$TAR"

      - name: Upload to EC2 (scp)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "${{ steps.pkg.outputs.tar }}"
          target: "/home/ubuntu/apps/${{ env.APP_NAME }}/tmp"

      - name: Remote deploy (ssh)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            APP_NAME="${{ env.APP_NAME }}"
            APP_ROOT="/home/ubuntu/apps/$APP_NAME"
            RELEASES="$APP_ROOT/${{ env.RELEASE_DIR }}"
            TMP="$APP_ROOT/tmp"
            TS="${{ steps.pkg.outputs.ts }}"
            TAR="$TMP/$APP_NAME-$TS.tgz"
            NEW="$RELEASES/$TS"

            mkdir -p "$RELEASES" "$TMP"

            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            command -v pm2 >/dev/null 2>&1 || sudo npm i -g pm2

            mkdir -p "$NEW"
            tar -C "$NEW" -xzf "$TAR"

            cat > "$NEW/${{ env.SERVER_SUBDIR }}/.env" <<'ENV'
            DB_HOST=127.0.0.1
            DB_PORT=3306
            DB_NAME=appdb
            DB_USER=appuser
            DB_PASSWORD=
            NODE_ENV=production
            PORT=3000
            ENV

            cd "$NEW/${{ env.SERVER_SUBDIR }}"
            if [ -f package-lock.json ]; then npm ci --omit=dev; else npm install --omit=dev; fi

            ln -sfn "$NEW" "$APP_ROOT/current"

            if [ -f ecosystem.config.js ]; then
              pm2 startOrReload ecosystem.config.js --update-env --only "$APP_NAME" || pm2 start ecosystem.config.js --only "$APP_NAME"
            else
              if pm2 describe "$APP_NAME" >/dev/null 2>&1; then
                pm2 reload "$APP_NAME" --update-env
              else
                pm2 start app.js --name "$APP_NAME"
              fi
            fi
            pm2 save

            if [ -d "$NEW/${{ env.CLIENT_SUBDIR }}/build" ]; then
              sudo mkdir -p /var/www/$APP_NAME
              sudo rsync -a --delete "$NEW/${{ env.CLIENT_SUBDIR }}/build/" /var/www/$APP_NAME/
              sudo systemctl reload nginx || true
            fi

            ls -1 "$RELEASES" | sort | head -n -5 | xargs -I {} rm -rf "$RELEASES/{}" || true

            echo "OK $TS"
