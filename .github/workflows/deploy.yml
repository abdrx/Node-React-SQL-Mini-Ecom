name: Deploy mini-ecom (raw upload; build on EC2)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      EC2_HOST: "54.246.33.23"
      APP_NAME: mini-ecom
      APP_ROOT: /home/ubuntu/apps/mini-ecom
      SERVER_SUBDIR: server
      CLIENT_SUBDIR: client

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            mkdir -p ${{ env.APP_ROOT }}/current/${{ env.SERVER_SUBDIR }}
            mkdir -p ${{ env.APP_ROOT }}/current/${{ env.CLIENT_SUBDIR }}

      - name: Upload server (raw)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "server/**"
          target: "${{ env.APP_ROOT }}/current/server"
          overwrite: true

      - name: Upload client (raw)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "client/**"
          target: "${{ env.APP_ROOT }}/current/client"
          overwrite: true

      - name: Build & run on EC2 (PM2 + Nginx)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            APP_NAME="${{ env.APP_NAME }}"
            ROOT="${{ env.APP_ROOT }}/current"
            SERVER="$ROOT/${{ env.SERVER_SUBDIR }}"
            CLIENT="$ROOT/${{ env.CLIENT_SUBDIR }}"

            # Node 22 + npm 10.9 + pm2
            if ! command -v node >/dev/null 2>&1 || [ "$(node -v | cut -d. -f1)" != "v22" ]; then
              curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            sudo npm -g i npm@10.9.3
            command -v pm2 >/dev/null 2>&1 || sudo npm -g i pm2

            # --- SERVER ---
            cat > "$SERVER/.env" <<'ENV'
            DB_HOST=127.0.0.1
            DB_PORT=3306
            DB_NAME=appdb
            DB_USER=appuser
            DB_PASSWORD=
            NODE_ENV=production
            PORT=3000
            ENV

            cd "$SERVER"
            if [ -f package-lock.json ]; then npm ci --omit=dev; else npm i --omit=dev; fi

            if [ -f ecosystem.config.js ]; then
              pm2 startOrReload ecosystem.config.js --update-env --only "$APP_NAME" || pm2 start ecosystem.config.js --only "$APP_NAME"
            else
              if pm2 describe "$APP_NAME" >/dev/null 2>&1; then
                pm2 reload "$APP_NAME" --update-env
              else
                pm2 start app.js --name "$APP_NAME"
              fi
            fi
            pm2 save

            # --- CLIENT (build on EC2) ---
            echo "REACT_APP_API_BASE=/api" > "$CLIENT/.env.production"
            echo "VITE_API_BASE=/api"     >> "$CLIENT/.env.production"

            cd "$CLIENT"
            export CI=false
            if [ -f package.json ]; then
              if [ -f package-lock.json ]; then npm ci; else npm i; fi
              if npm run | grep -q "^  build"; then npm run build; fi
            else
              echo "No client/package.json found; skipping client build."
            fi

            # --- NGINX (serve / + proxy /api -> 127.0.0.1:3000) ---
            if ! dpkg -s nginx >/dev/null 2>&1; then
              sudo apt-get update -y && sudo apt-get install -y nginx
            fi

            BUILD_DIR="$CLIENT/build"
            if [ -d "$BUILD_DIR" ]; then
              sudo mkdir -p /var/www/$APP_NAME
              sudo rsync -a --delete "$BUILD_DIR/" /var/www/$APP_NAME/
            fi

            sudo tee /etc/nginx/sites-available/$APP_NAME.conf >/dev/null <<NGINX
            server {
              listen 80;
              server_name _;

              root /var/www/$APP_NAME;
              index index.html;

              location / {
                try_files \$uri \$uri/ /index.html;
              }

              location /api/ {
                proxy_pass http://127.0.0.1:3000/;
                proxy_http_version 1.1;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_set_header Upgrade \$http_upgrade;
                proxy_set_header Connection "upgrade";
              }
            }
            NGINX
                        sudo ln -sf /etc/nginx/sites-available/$APP_NAME.conf /etc/nginx/sites-enabled/$APP_NAME.conf
                        sudo rm -f /etc/nginx/sites-enabled/default || true
                        sudo nginx -t
                        sudo systemctl enable --now nginx
                        sudo systemctl reload nginx || true

                        echo "âœ… Deploy done (current/ path)."
