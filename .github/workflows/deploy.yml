jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_NAME: mini-ecom
      EC2_HOST: "54.246.33.23"   
      SERVER_SUBDIR: server
      CLIENT_SUBDIR: client
      RELEASE_DIR: releases
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 22.19.0
        uses: actions/setup-node@v4
        with:
          node-version: '22.19.0'
          cache: npm
          cache-dependency-path: |
            client/package-lock.json
            server/package-lock.json

      - name: Set npm 10.9.3
        run: npm i -g npm@10.9.3

      - name: Build client (ignore warnings)
        working-directory: client
        env:
          CI: "false"
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build

      - name: Package server + client build
        id: pkg
        run: |
          set -e
          TS=$(date -u +%Y%m%d%H%M%S)
          echo "ts=$TS" >> $GITHUB_OUTPUT
          mkdir -p deploy_bundle/server deploy_bundle/client/build
          rsync -a --exclude=node_modules --exclude=.env --exclude=.git server/ deploy_bundle/server/
          rsync -a client/build/ deploy_bundle/client/build/
          TAR="${{ env.APP_NAME }}-$TS.tgz"
          tar -C deploy_bundle -czf "$TAR" .
          echo "tar=$TAR" >> $GITHUB_OUTPUT

      # Ensure target dirs exist BEFORE scp
      - name: Prepare server folders
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p /home/ubuntu/apps/${{ env.APP_NAME }}/tmp

      - name: Upload to EC2 (scp)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "${{ steps.pkg.outputs.tar }}"
          target: "/home/ubuntu/apps/${{ env.APP_NAME }}/tmp"

      - name: Remote deploy (ssh)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ env.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            APP="${{ env.APP_NAME }}"
            ROOT="/home/ubuntu/apps/$APP"
            RELS="$ROOT/${{ env.RELEASE_DIR }}"
            TMP="$ROOT/tmp"
            TS="${{ steps.pkg.outputs.ts }}"
            TAR="$TMP/$APP-$TS.tgz"
            NEW="$RELS/$TS"

            mkdir -p "$RELS"

            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            command -v pm2 >/dev/null 2>&1 || sudo npm i -g pm2

            mkdir -p "$NEW"
            tar -C "$NEW" -xzf "$TAR"

            cat > "$NEW/server/.env" <<'ENV'
            DB_HOST=127.0.0.1
            DB_PORT=3306
            DB_NAME=appdb
            DB_USER=appuser
            DB_PASSWORD=
            NODE_ENV=production
            PORT=3000
            ENV

            cd "$NEW/server"
            if [ -f package-lock.json ]; then npm ci --omit=dev; else npm install --omit=dev; fi

            ln -sfn "$NEW" "$ROOT/current"

            if [ -f ecosystem.config.js ]; then
              pm2 startOrReload ecosystem.config.js --update-env --only "$APP" || pm2 start ecosystem.config.js --only "$APP"
            else
              if pm2 describe "$APP" >/dev/null 2>&1; then
                pm2 reload "$APP" --update-env
              else
                pm2 start app.js --name "$APP"
              fi
            fi
            pm2 save

            if [ -d "$NEW/client/build" ]; then
              sudo mkdir -p /var/www/$APP
              sudo rsync -a --delete "$NEW/client/build/" /var/www/$APP/
              sudo systemctl reload nginx || true
            fi

            ls -1 "$RELS" | sort | head -n -5 | xargs -I {} rm -rf "$RELS/{}" || true

            echo "âœ… Deployed $TS"
